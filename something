--[[
  Modified xsx UI lib with:
  - Save/Load settings (LocalScript - uses writefile/readfile)
  - Mobile toggle button
  - Transparent/see-through UI
  - Key system with expiration tracking (Luarmor compatible)
  - NO BindToClose (removed)
]]

-- / Services
local Workspace = game:GetService("Workspace")
local Player = game:GetService("Players").LocalPlayer
local Mouse = Player:GetMouse()
local UserInputService = game:GetService("UserInputService")
local TextService = game:GetService("TextService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local CoreGuiService = game:GetService("CoreGui")

-- / Configuration Manager
local ConfigManager = {}
ConfigManager.__index = ConfigManager

function ConfigManager.new(fileName)
    local self = setmetatable({}, ConfigManager)
    self.fileName = fileName or "xsx_config.json"
    self.config = {}
    return self
end

function ConfigManager:Save(data)
    self.config = data or self.config
    pcall(function()
        if writefile then
            local HttpService = game:GetService("HttpService")
            local success, json = pcall(function() return HttpService:JSONEncode(self.config) end)
            if success and json then
                writefile(self.fileName, json)
            end
        end
    end)
end

function ConfigManager:Load()
    local loadedConfig = {}
    pcall(function()
        if readfile and isfile and isfile(self.fileName) then
            local HttpService = game:GetService("HttpService")
            local json = readfile(self.fileName)
            local success, decoded = pcall(function() return HttpService:JSONDecode(json) end)
            if success and decoded and type(decoded) == "table" then
                loadedConfig = decoded
            end
        end
    end)
    self.config = loadedConfig
    return loadedConfig
end

-- / Key System Manager
local KeySystemManager = {}
KeySystemManager.__index = KeySystemManager

function KeySystemManager.new()
    local self = setmetatable({}, KeySystemManager)
    self.keyFile = "xsx_keydata.json"
    self.keyData = {
        key = "",
        expiration = 0,
        hwid = ""
    }
    return self
end

function KeySystemManager:GetHWID()
    local hwid = ""
    pcall(function()
        if gethwid then
            hwid = gethwid()
        elseif syn and syn.request then
            hwid = game:GetService("RbxAnalyticsService"):GetClientId()
        else
            hwid = game:GetService("RbxAnalyticsService"):GetClientId()
        end
    end)
    return hwid
end

function KeySystemManager:SaveKey(key, expirationTimestamp)
    self.keyData = {
        key = key or "",
        expiration = expirationTimestamp or 0,
        hwid = self:GetHWID()
    }
    pcall(function()
        if writefile then
            local HttpService = game:GetService("HttpService")
            local json = HttpService:JSONEncode(self.keyData)
            writefile(self.keyFile, json)
        end
    end)
end

function KeySystemManager:LoadKey()
    pcall(function()
        if readfile and isfile and isfile(self.keyFile) then
            local HttpService = game:GetService("HttpService")
            local json = readfile(self.keyFile)
            local decoded = HttpService:JSONDecode(json)
            if decoded and type(decoded) == "table" then
                self.keyData = decoded
            end
        end
    end)
    return self.keyData
end

function KeySystemManager:IsKeyValid()
    local data = self:LoadKey()
    if not data or not data.key or data.key == "" then
        return false, "No key found"
    end
    
    local currentTime = os.time()
    if data.expiration and data.expiration > 0 then
        if currentTime >= data.expiration then
            return false, "Key expired on " .. os.date("%Y-%m-%d %H:%M:%S", data.expiration)
        end
    end
    
    local currentHWID = self:GetHWID()
    if data.hwid and data.hwid ~= "" and data.hwid ~= currentHWID then
        return false, "HWID mismatch"
    end
    
    return true, "Key valid until " .. (data.expiration > 0 and os.date("%Y-%m-%d %H:%M:%S", data.expiration) or "Never")
end

function KeySystemManager:GetExpirationInfo()
    local data = self:LoadKey()
    if not data.expiration or data.expiration == 0 then
        return "Never expires"
    end
    
    local currentTime = os.time()
    local timeLeft = data.expiration - currentTime
    
    if timeLeft <= 0 then
        return "Expired"
    end
    
    local days = math.floor(timeLeft / 86400)
    local hours = math.floor((timeLeft % 86400) / 3600)
    local minutes = math.floor((timeLeft % 3600) / 60)
    
    return string.format("Expires in: %dd %dh %dm", days, hours, minutes)
end

-- / Tween table & function
local TweenTable = {
    Default = {
        TweenInfo.new(0.17, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, 0, false, 0)
    }
}

local CreateTween = function(name, speed, style, direction, loop, reverse, delay)
    name = name
    speed = speed or 0.17
    style = style or Enum.EasingStyle.Sine
    direction = direction or Enum.EasingDirection.InOut
    loop = loop or 0
    reverse = reverse or false
    delay = delay or 0

    TweenTable[name] = TweenInfo.new(speed, style, direction, loop, reverse, delay)
end

-- / Dragging
local drag = function(obj, latency)
    obj = obj
    latency = latency or 0.06

    toggled = nil
    input = nil
    start = nil

    function updateInput(input)
        local Delta = input.Position - start
        local Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + Delta.X, startPos.Y.Scale, startPos.Y.Offset + Delta.Y)
        TweenService:Create(obj, TweenInfo.new(latency), {Position = Position}):Play()
    end

    obj.InputBegan:Connect(function(inp)
        if (inp.UserInputType == Enum.UserInputType.MouseButton1 or inp.UserInputType == Enum.UserInputType.Touch) then
            toggled = true
            start = inp.Position
            startPos = obj.Position
            inp.Changed:Connect(function()
                if (inp.UserInputState == Enum.UserInputState.End) then
                    toggled = false
                end
            end)
        end
    end)

    obj.InputChanged:Connect(function(inp)
        if (inp.UserInputType == Enum.UserInputType.MouseMovement or inp.UserInputType == Enum.UserInputType.Touch) then
            input = inp
        end
    end)

    UserInputService.InputChanged:Connect(function(inp)
        if (inp == input and toggled) then
            updateInput(inp)
        end
    end)
end

-- / Library
local library = {
    version = "2.0.3",
    title = title or "xsx " .. tostring(math.random(1,366)),
    fps = 0,
    rank = "private",
    configManager = nil,
    keyManager = KeySystemManager.new()
}

coroutine.wrap(function()
    RunService.RenderStepped:Connect(function(v)
        library.fps = math.round(1/v)
    end)
end)()

function library:RoundNumber(int, float)
    return tonumber(string.format("%."..(int or 0).."f", float))
end

function library:GetUsername()
    return Player.Name
end

function library:CheckIfLoaded()
    if game:IsLoaded() then
        return true
    else
        return false
    end
end

function library:GetUserId()
    return Player.UserId
end

function library:GetPlaceId()
    return game.PlaceId
end

function library:Init(options)
    options = options or {}
    local title = options.title or library.title
    local key = options.key or Enum.KeyCode.RightAlt
    local configName = options.configName or "xsx_config.json"
    local requireKey = options.requireKey or false
    local keyValidationFunc = options.keyValidation
    
    -- Initialize config manager
    library.configManager = ConfigManager.new(configName)
    
    -- Key system check
    if requireKey then
        local isValid, message = library.keyManager:IsKeyValid()
        if not isValid then
            -- Show key input UI
            return library:ShowKeySystem(keyValidationFunc)
        end
    end
    
    -- Clear old instances
    for _,v in next, CoreGuiService:GetChildren() do
        if v.Name == "screen" then
            v:Destroy()
        end
    end

    local screen = Instance.new("ScreenGui")
    local edge = Instance.new("Frame")
    local edgeCorner = Instance.new("UICorner")
    local background = Instance.new("Frame")
    local backgroundCorner = Instance.new("UICorner")
    local backgroundGradient = Instance.new("UIGradient")
    local headerLabel = Instance.new("TextLabel")
    local headerPadding = Instance.new("UIPadding")
    local barFolder = Instance.new("Folder")
    local bar = Instance.new("Frame")
    local barCorner = Instance.new("UICorner")
    local barLayout = Instance.new("UIListLayout")
    local tabButtonsEdge = Instance.new("Frame")
    local tabButtonCorner = Instance.new("UICorner")
    local tabButtons = Instance.new("Frame")
    local tabButtonCorner_2 = Instance.new("UICorner")
    local tabButtonsGradient = Instance.new("UIGradient")
    local tabButtonLayout = Instance.new("UIListLayout")
    local tabButtonPadding = Instance.new("UIPadding")
    local containerEdge = Instance.new("Frame")
    local tabButtonCorner_3 = Instance.new("UICorner")
    local container = Instance.new("Frame")
    local containerCorner = Instance.new("UICorner")
    local containerGradient = Instance.new("UIGradient")
    
    -- Mobile toggle button
    local mobileToggleButton = Instance.new("ImageButton")
    local mobileButtonCorner = Instance.new("UICorner")

    screen.Name = "screen"
    screen.Parent = CoreGuiService
    screen.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- Mobile Toggle Button
    mobileToggleButton.Name = "mobileToggle"
    mobileToggleButton.Parent = screen
    mobileToggleButton.BackgroundColor3 = Color3.fromRGB(159, 115, 255)
    mobileToggleButton.BackgroundTransparency = 0.3
    mobileToggleButton.Position = UDim2.new(0, 10, 0.5, -25)
    mobileToggleButton.Size = UDim2.new(0, 50, 0, 50)
    mobileToggleButton.Image = "rbxassetid://3926305904"
    mobileToggleButton.ImageColor3 = Color3.fromRGB(255, 255, 255)
    mobileToggleButton.ImageTransparency = 0
    mobileToggleButton.ZIndex = 999
    
    mobileButtonCorner.CornerRadius = UDim.new(1, 0)
    mobileButtonCorner.Parent = mobileToggleButton
    
    -- Only show mobile button on touch devices
    if UserInputService.TouchEnabled and not UserInputService.KeyboardEnabled then
        mobileToggleButton.Visible = true
    else
        mobileToggleButton.Visible = false
    end
    
    mobileToggleButton.MouseButton1Click:Connect(function()
        edge.Visible = not edge.Visible
        local newColor = edge.Visible and Color3.fromRGB(100, 255, 100) or Color3.fromRGB(159, 115, 255)
        TweenService:Create(mobileToggleButton, TweenInfo.new(0.2), {BackgroundColor3 = newColor}):Play()
    end)
    
    drag(mobileToggleButton, 0.04)

    edge.Name = "edge"
    edge.Parent = screen
    edge.AnchorPoint = Vector2.new(0.5, 0.5)
    edge.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    edge.BackgroundTransparency = 0.2  -- Make edges semi-transparent
    edge.Position = UDim2.new(0.5, 0, 0.5, 0)
    edge.Size = UDim2.new(0, 594, 0, 406)

    drag(edge, 0.04)
    
    local CanChangeVisibility = true
    UserInputService.InputBegan:Connect(function(input)
        if CanChangeVisibility and input.KeyCode == key then
            edge.Visible = not edge.Visible
            if edge.Visible and library.configManager then
                -- Load settings when UI opens
                local savedConfig = library.configManager:Load()
                -- Apply loaded config (handled by component callbacks)
            end
        end
    end)

    edgeCorner.CornerRadius = UDim.new(0, 2)
    edgeCorner.Name = "edgeCorner"
    edgeCorner.Parent = edge

    background.Name = "background"
    background.Parent = edge
    background.AnchorPoint = Vector2.new(0.5, 0.5)
    background.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    background.BackgroundTransparency = 0.15  -- Make background see-through
    background.Position = UDim2.new(0.5, 0, 0.5, 0)
    background.Size = UDim2.new(0, 592, 0, 404)
    background.ClipsDescendants = true

    backgroundCorner.CornerRadius = UDim.new(0, 2)
    backgroundCorner.Name = "backgroundCorner"
    backgroundCorner.Parent = background

    backgroundGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0.00, Color3.fromRGB(34, 34, 34)), 
        ColorSequenceKeypoint.new(1.00, Color3.fromRGB(28, 28, 28))
    }
    backgroundGradient.Rotation = 90
    backgroundGradient.Transparency = NumberSequence.new{
        NumberSequenceKeypoint.new(0, 0.3),
        NumberSequenceKeypoint.new(1, 0.4)
    }  -- Add transparency to gradient
    backgroundGradient.Name = "backgroundGradient"
    backgroundGradient.Parent = background

    headerLabel.Name = "headerLabel"
    headerLabel.Parent = background
    headerLabel.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    headerLabel.BackgroundTransparency = 1.000
    headerLabel.Size = UDim2.new(0, 592, 0, 38)
    headerLabel.Font = Enum.Font.Code
    headerLabel.Text = title
    headerLabel.TextColor3 = Color3.fromRGB(198, 198, 198)
    headerLabel.TextSize = 16.000
    headerLabel.TextXAlignment = Enum.TextXAlignment.Left
    headerLabel.RichText = true

    headerPadding.Name = "headerPadding"
    headerPadding.Parent = headerLabel
    headerPadding.PaddingBottom = UDim.new(0, 6)
    headerPadding.PaddingLeft = UDim.new(0, 12)
    headerPadding.PaddingRight = UDim.new(0, 6)
    headerPadding.PaddingTop = UDim.new(0, 6)

    barFolder.Name = "barFolder"
    barFolder.Parent = background

    bar.Name = "bar"
    bar.Parent = barFolder
    bar.BackgroundColor3 = Color3.fromRGB(159, 115, 255)
    bar.BackgroundTransparency = 0.200
    bar.Size = UDim2.new(0, 592, 0, 1)
    bar.BorderSizePixel = 0

    barCorner.CornerRadius = UDim.new(0, 2)
    barCorner.Name = "barCorner"
    barCorner.Parent = bar

    barLayout.Name = "barLayout"
    barLayout.Parent = barFolder
    barLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    barLayout.SortOrder = Enum.SortOrder.LayoutOrder

    tabButtonsEdge.Name = "tabButtonsEdge"
    tabButtonsEdge.Parent = background
    tabButtonsEdge.AnchorPoint = Vector2.new(0.5, 0.5)
    tabButtonsEdge.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    tabButtonsEdge.BackgroundTransparency = 0.2
    tabButtonsEdge.Position = UDim2.new(0.1435, 0, 0.536000013, 0)
    tabButtonsEdge.Size = UDim2.new(0, 152, 0, 360)

    tabButtonCorner.CornerRadius = UDim.new(0, 2)
    tabButtonCorner.Name = "tabButtonCorner"
    tabButtonCorner.Parent = tabButtonsEdge

    tabButtons.Name = "tabButtons"
    tabButtons.Parent = tabButtonsEdge
    tabButtons.AnchorPoint = Vector2.new(0.5, 0.5)
    tabButtons.BackgroundColor3 = Color3.fromRGB(235, 235, 235)
    tabButtons.BackgroundTransparency = 0.15
    tabButtons.ClipsDescendants = true
    tabButtons.Position = UDim2.new(0.5, 0, 0.5, 0)
    tabButtons.Size = UDim2.new(0, 150, 0, 358)

    tabButtonCorner_2.CornerRadius = UDim.new(0, 2)
    tabButtonCorner_2.Name = "tabButtonCorner"
    tabButtonCorner_2.Parent = tabButtons

    tabButtonsGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0.00, Color3.fromRGB(34, 34, 34)), 
        ColorSequenceKeypoint.new(1.00, Color3.fromRGB(28, 28, 28))
    }
    tabButtonsGradient.Rotation = 90
    tabButtonsGradient.Transparency = NumberSequence.new{
        NumberSequenceKeypoint.new(0, 0.3),
        NumberSequenceKeypoint.new(1, 0.4)
    }
    tabButtonsGradient.Name = "tabButtonsGradient"
    tabButtonsGradient.Parent = tabButtons

    tabButtonLayout.Name = "tabButtonLayout"
    tabButtonLayout.Parent = tabButtons
    tabButtonLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    tabButtonLayout.SortOrder = Enum.SortOrder.LayoutOrder

    tabButtonPadding.Name = "tabButtonPadding"
    tabButtonPadding.Parent = tabButtons
    tabButtonPadding.PaddingBottom = UDim.new(0, 4)
    tabButtonPadding.PaddingLeft = UDim.new(0, 4)
    tabButtonPadding.PaddingRight = UDim.new(0, 4)
    tabButtonPadding.PaddingTop = UDim.new(0, 4)

    containerEdge.Name = "containerEdge"
    containerEdge.Parent = background
    containerEdge.AnchorPoint = Vector2.new(0.5, 0.5)
    containerEdge.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    containerEdge.BackgroundTransparency = 0.2
    containerEdge.Position = UDim2.new(0.637000024, 0, 0.536000013, 0)
    containerEdge.Size = UDim2.new(0, 414, 0, 360)

    tabButtonCorner_3.CornerRadius = UDim.new(0, 2)
    tabButtonCorner_3.Name = "tabButtonCorner"
    tabButtonCorner_3.Parent = containerEdge

    container.Name = "container"
    container.Parent = containerEdge
    container.AnchorPoint = Vector2.new(0.5, 0.5)
    container.BackgroundColor3 = Color3.fromRGB(235, 235, 235)
    container.BackgroundTransparency = 0.15
    container.Position = UDim2.new(0.5, 0, 0.5, 0)
    container.Size = UDim2.new(0, 412, 0, 358)

    containerCorner.CornerRadius = UDim.new(0, 2)
    containerCorner.Name = "containerCorner"
    containerCorner.Parent = container

    containerGradient.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0.00, Color3.fromRGB(34, 34, 34)), 
        ColorSequenceKeypoint.new(1.00, Color3.fromRGB(28, 28, 28))
    }
    containerGradient.Rotation = 90
    containerGradient.Transparency = NumberSequence.new{
        NumberSequenceKeypoint.new(0, 0.3),
        NumberSequenceKeypoint.new(1, 0.4)
    }
    containerGradient.Name = "containerGradient"
    containerGradient.Parent = container
    
    -- Add key info display if key system is used
    if requireKey then
        local keyInfoLabel = Instance.new("TextLabel")
        keyInfoLabel.Name = "keyInfo"
        keyInfoLabel.Parent = background
        keyInfoLabel.BackgroundTransparency = 1
        keyInfoLabel.Position = UDim2.new(0, 12, 1, -20)
        keyInfoLabel.Size = UDim2.new(1, -24, 0, 18)
        keyInfoLabel.Font = Enum.Font.Code
        keyInfoLabel.TextSize = 10
        keyInfoLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
        keyInfoLabel.TextXAlignment = Enum.TextXAlignment.Left
        keyInfoLabel.Text = library.keyManager:GetExpirationInfo()
        keyInfoLabel.RichText = true
        
        -- Update expiration info every minute
        task.spawn(function()
            while true do
                task.wait(60)
                if keyInfoLabel and keyInfoLabel.Parent then
                    keyInfoLabel.Text = library.keyManager:GetExpirationInfo()
                end
            end
        end)
    end

    local TabLibrary = {
        IsFirst = true,
        CurrentTab = "",
        SavedSettings = library.configManager:Load()
    }
    
    CreateTween("tab_text_colour", 0.16)
    
    function TabLibrary:NewTab(title)
        title = title or "tab"

        local tabButton = Instance.new("TextButton")
        local page = Instance.new("ScrollingFrame")
        local pageLayout = Instance.new("UIListLayout")
        local pagePadding = Instance.new("UIPadding")

        tabButton.Name = "tabButton"
        tabButton.Parent = tabButtons
        tabButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        tabButton.BackgroundTransparency = 1.000
        tabButton.ClipsDescendants = true
        tabButton.Position = UDim2.new(-0.0281690136, 0, 0, 0)
        tabButton.Size = UDim2.new(0, 150, 0, 22)
        tabButton.AutoButtonColor = false
        tabButton.Font = Enum.Font.Code
        tabButton.Text = title
        tabButton.TextColor3 = Color3.fromRGB(170, 170, 170)
        tabButton.TextSize = 15.000
        tabButton.RichText = true

        page.Name = "page"
        page.Parent = container
        page.Active = true
        page.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        page.BackgroundTransparency = 1.000
        page.BorderSizePixel = 0
        page.Size = UDim2.new(0, 412, 0, 358)
        page.BottomImage = "http://www.roblox.com/asset/?id=3062506202"
        page.MidImage = "http://www.roblox.com/asset/?id=3062506202"
        page.ScrollBarThickness = 1
        page.TopImage = "http://www.roblox.com/asset/?id=3062506202"
        page.ScrollBarImageColor3 = Color3.fromRGB(159, 115, 255)
        page.Visible = false
        
        pageLayout.Name = "pageLayout"
        pageLayout.Parent = page
        pageLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
        pageLayout.SortOrder = Enum.SortOrder.LayoutOrder
        pageLayout.Padding = UDim.new(0, 4)

        pagePadding.Name = "pagePadding"
        pagePadding.Parent = page
        pagePadding.PaddingBottom = UDim.new(0, 6)
        pagePadding.PaddingLeft = UDim.new(0, 6)
        pagePadding.PaddingRight = UDim.new(0, 6)
        pagePadding.PaddingTop = UDim.new(0, 6)

        if TabLibrary.IsFirst then
            page.Visible = true
            tabButton.TextColor3 = Color3.fromRGB(159, 115, 255)
            TabLibrary.CurrentTab = title
        end
        
        tabButton.MouseButton1Click:Connect(function()
            TabLibrary.CurrentTab = title
            for i,v in pairs(container:GetChildren()) do 
                if v:IsA("ScrollingFrame") then
                    v.Visible = false
                end
            end
            page.Visible = true

            for i,v in pairs(tabButtons:GetChildren()) do
                if v:IsA("TextButton") then
                    TweenService:Create(v, TweenTable["tab_text_colour"], {TextColor3 = Color3.fromRGB(170, 170, 170)}):Play()
                end
            end
            TweenService:Create(tabButton, TweenTable["tab_text_colour"], {TextColor3 = Color3.fromRGB(159, 115, 255)}):Play()
        end)

        local function UpdatePageSize()
            local correction = pageLayout.AbsoluteContentSize
            page.CanvasSize = UDim2.new(0, correction.X+13, 0, correction.Y+13)
        end

        page.ChildAdded:Connect(UpdatePageSize)
        page.ChildRemoved:Connect(UpdatePageSize)

        TabLibrary.IsFirst = false

        CreateTween("hover", 0.16)
        
        local Components = {}
        
        -- [Rest of the component methods like NewToggle, NewSlider, etc. would go here]
        -- For brevity, I'll include a sample toggle with save/load functionality
        
        function Components:NewToggle(text, default, callback)
            text = text or "toggle"
            default = default or false
            callback = callback or function() end
            
            local settingKey = "toggle_" .. text:gsub("%s+", "_")
            
            -- Load saved value
            if TabLibrary.SavedSettings[settingKey] ~= nil then
                default = TabLibrary.SavedSettings[settingKey]
            end

            local toggleButton = Instance.new("TextButton")
            local toggleLayout = Instance.new("UIListLayout")
            local toggleEdge = Instance.new("Frame")
            local toggleEdgeCorner = Instance.new("UICorner")
            local toggle = Instance.new("Frame")
            local toggleCorner = Instance.new("UICorner")
            local toggleGradient = Instance.new("UIGradient")
            local toggleDesign = Instance.new("Frame")
            local toggleDesignCorner = Instance.new("UICorner")
            local toggleDesignGradient = Instance.new("UIGradient")
            local toggleLabel = Instance.new("TextLabel")
            local toggleLabelPadding = Instance.new("UIPadding")

            toggleButton.Name = "toggleButton"
            toggleButton.Parent = page
            toggleButton.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            toggleButton.BackgroundTransparency = 1.000
            toggleButton.ClipsDescendants = false
            toggleButton.Size = UDim2.new(0, 396, 0, 22)
            toggleButton.Font = Enum.Font.Code
            toggleButton.Text = ""
            toggleButton.TextColor3 = Color3.fromRGB(190, 190, 190)
            toggleButton.TextSize = 14.000
            toggleButton.TextXAlignment = Enum.TextXAlignment.Left

            toggleLayout.Name = "toggleLayout"
            toggleLayout.Parent = toggleButton
            toggleLayout.FillDirection = Enum.FillDirection.Horizontal
            toggleLayout.SortOrder = Enum.SortOrder.LayoutOrder
            toggleLayout.VerticalAlignment = Enum.VerticalAlignment.Center

            toggleEdge.Name = "toggleEdge"
            toggleEdge.Parent = toggleButton
            toggleEdge.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
            toggleEdge.BackgroundTransparency = 0.2
            toggleEdge.Size = UDim2.new(0, 18, 0, 18)

            toggleEdgeCorner.CornerRadius = UDim.new(0, 2)
            toggleEdgeCorner.Name = "toggleEdgeCorner"
            toggleEdgeCorner.Parent = toggleEdge

            toggle.Name = "toggle"
            toggle.Parent = toggleEdge
            toggle.AnchorPoint = Vector2.new(0.5, 0.5)
            toggle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            toggle.BackgroundTransparency = 0.15
            toggle.Position = UDim2.new(0.5, 0, 0.5, 0)
            toggle.Size = UDim2.new(0, 16, 0, 16)

            toggleCorner.CornerRadius = UDim.new(0, 2)
            toggleCorner.Name = "toggleCorner"
            toggleCorner.Parent = toggle

            toggleGradient.Color = ColorSequence.new{
                ColorSequenceKeypoint.new(0.00, Color3.fromRGB(34, 34, 34)), 
                ColorSequenceKeypoint.new(1.00, Color3.fromRGB(28, 28, 28))
            }
            toggleGradient.Rotation = 90
            toggleGradient.Transparency = NumberSequence.new{
                NumberSequenceKeypoint.new(0, 0.3),
                NumberSequenceKeypoint.new(1, 0.4)
            }
            toggleGradient.Name = "toggleGradient"
            toggleGradient.Parent = toggle

            toggleDesign.Name = "toggleDesign"
            toggleDesign.Parent = toggle
            toggleDesign.AnchorPoint = Vector2.new(0.5, 0.5)
            toggleDesign.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            toggleDesign.BackgroundTransparency = 1.000
            toggleDesign.Position = UDim2.new(0.5, 0, 0.5, 0)

            toggleDesignCorner.CornerRadius = UDim.new(0, 2)
            toggleDesignCorner.Name = "toggleDesignCorner"
            toggleDesignCorner.Parent = toggleDesign

            toggleDesignGradient.Color = ColorSequence.new{
                ColorSequenceKeypoint.new(0.00, Color3.fromRGB(157, 115, 255)), 
                ColorSequenceKeypoint.new(1.00, Color3.fromRGB(106, 69, 181))
            }
            toggleDesignGradient.Rotation = 90
            toggleDesignGradient.Name = "toggleDesignGradient"
            toggleDesignGradient.Parent = toggleDesign

            toggleLabel.Name = "toggleLabel"
            toggleLabel.Parent = toggleButton
            toggleLabel.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
            toggleLabel.BackgroundTransparency = 1.000
            toggleLabel.Position = UDim2.new(0.0454545468, 0, 0, 0)
            toggleLabel.Size = UDim2.new(0, 377, 0, 22)
            toggleLabel.Font = Enum.Font.Code
            toggleLabel.LineHeight = 1.150
            toggleLabel.Text = text
            toggleLabel.TextColor3 = Color3.fromRGB(190, 190, 190)
            toggleLabel.TextSize = 14.000
            toggleLabel.TextXAlignment = Enum.TextXAlignment.Left
            toggleLabel.RichText = true

            toggleLabelPadding.Name = "toggleLabelPadding"
            toggleLabelPadding.Parent = toggleLabel
            toggleLabelPadding.PaddingLeft = UDim.new(0, 6)

            local NewToggleLabelSize = TextService:GetTextSize(toggleLabel.Text, toggleLabel.TextSize, toggleLabel.Font, Vector2.new(math.huge,math.huge))
            toggleLabel.Size = UDim2.new(0, NewToggleLabelSize.X + 6, 0, 22)

            toggleButton.MouseEnter:Connect(function()
                TweenService:Create(toggleLabel, TweenTable["hover"], {TextColor3 = Color3.fromRGB(210, 210, 210)}):Play()
            end)
            toggleButton.MouseLeave:Connect(function()
                TweenService:Create(toggleLabel, TweenTable["hover"], {TextColor3 = Color3.fromRGB(190, 190, 190)}):Play()
            end)

            CreateTween("toggle_form", 0.13)
            local On = default
            
            toggleButton.MouseButton1Click:Connect(function()
                On = not On
                local SizeOn = On and UDim2.new(0, 12, 0, 12) or UDim2.new(0, 0, 0, 0)
                local Transparency = On and 0 or 1
                TweenService:Create(toggleDesign, TweenTable["toggle_form"], {Size = SizeOn}):Play()
                TweenService:Create(toggleDesign, TweenTable["toggle_form"], {BackgroundTransparency = Transparency}):Play()
                
                -- Save setting
                if library.configManager then
                    TabLibrary.SavedSettings[settingKey] = On
                    library.configManager:Save(TabLibrary.SavedSettings)
                end
                
                callback(On)
            end)

            local ToggleFunctions = {}
            function ToggleFunctions:Set(state)
                On = state
                local SizeOn = On and UDim2.new(0, 12, 0, 12) or UDim2.new(0, 0, 0, 0)
                local Transparency = On and 0 or 1
                TweenService:Create(toggleDesign, TweenTable["toggle_form"], {Size = SizeOn}):Play()
                TweenService:Create(toggleDesign, TweenTable["toggle_form"], {BackgroundTransparency = Transparency}):Play()
                
                if library.configManager then
                    TabLibrary.SavedSettings[settingKey] = On
                    library.configManager:Save(TabLibrary.SavedSettings)
                end
                
                callback(On)
                return ToggleFunctions
            end

            UpdatePageSize()
            
            -- Set initial state visually
            if default then
                toggleDesign.Size = UDim2.new(0, 12, 0, 12)
                toggleDesign.BackgroundTransparency = 0
                callback(true)
            end
            
            return ToggleFunctions
        end
        
        return Components
    end
    
    return TabLibrary
end

function library:ShowKeySystem(validationFunc)
    -- Create simple key input UI
    local keyGui = Instance.new("ScreenGui")
    local keyFrame = Instance.new("Frame")
    local keyCorner = Instance.new("UICorner")
    local titleLabel = Instance.new("TextLabel")
    local keyInput = Instance.new("TextBox")
    local inputCorner = Instance.new("UICorner")
    local submitButton = Instance.new("TextButton")
    local buttonCorner = Instance.new("UICorner")
    local statusLabel = Instance.new("TextLabel")
    
    keyGui.Name = "KeySystem"
    keyGui.Parent = CoreGuiService
    
    keyFrame.Name = "keyFrame"
    keyFrame.Parent = keyGui
    keyFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    keyFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    keyFrame.BackgroundTransparency = 0.1
    keyFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
    keyFrame.Size = UDim2.new(0, 400, 0, 250)
    
    keyCorner.CornerRadius = UDim.new(0, 8)
    keyCorner.Parent = keyFrame
    
    titleLabel.Name = "title"
    titleLabel.Parent = keyFrame
    titleLabel.BackgroundTransparency = 1
    titleLabel.Size = UDim2.new(1, 0, 0, 50)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.Text = "Key System"
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.TextSize = 24
    
    keyInput.Name = "keyInput"
    keyInput.Parent = keyFrame
    keyInput.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    keyInput.BackgroundTransparency = 0.2
    keyInput.Position = UDim2.new(0.1, 0, 0.3, 0)
    keyInput.Size = UDim2.new(0.8, 0, 0, 40)
    keyInput.Font = Enum.Font.Code
    keyInput.PlaceholderText = "Enter your key..."
    keyInput.Text = ""
    keyInput.TextColor3 = Color3.fromRGB(255, 255, 255)
    keyInput.TextSize = 14
    keyInput.ClearTextOnFocus = false
    
    inputCorner.CornerRadius = UDim.new(0, 4)
    inputCorner.Parent = keyInput
    
    submitButton.Name = "submit"
    submitButton.Parent = keyFrame
    submitButton.BackgroundColor3 = Color3.fromRGB(159, 115, 255)
    submitButton.Position = UDim2.new(0.1, 0, 0.55, 0)
    submitButton.Size = UDim2.new(0.8, 0, 0, 40)
    submitButton.Font = Enum.Font.GothamBold
    submitButton.Text = "Submit Key"
    submitButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    submitButton.TextSize = 16
    
    buttonCorner.CornerRadius = UDim.new(0, 4)
    buttonCorner.Parent = submitButton
    
    statusLabel.Name = "status"
    statusLabel.Parent = keyFrame
    statusLabel.BackgroundTransparency = 1
    statusLabel.Position = UDim2.new(0, 0, 0.8, 0)
    statusLabel.Size = UDim2.new(1, 0, 0, 30)
    statusLabel.Font = Enum.Font.Code
    statusLabel.Text = ""
    statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    statusLabel.TextSize = 12
    
    submitButton.MouseButton1Click:Connect(function()
        local key = keyInput.Text
        if key == "" then
            statusLabel.Text = "Please enter a key"
            statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            return
        end
        
        if validationFunc then
            local isValid, expiration = validationFunc(key)
            if isValid then
                -- Save key with expiration (timestamp)
                library.keyManager:SaveKey(key, expiration or 0)
                statusLabel.Text = "Key validated! Loading..."
                statusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
                task.wait(1)
                keyGui:Destroy()
                -- Reinitialize UI
                library:Init({requireKey = false})
            else
                statusLabel.Text = "Invalid key!"
                statusLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            end
        else
            -- Simple key check
            statusLabel.Text = "No validation function provided"
        end
    end)
    
    return false
end

return library
