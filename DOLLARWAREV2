-- ENHANCED DOLLARWARE UI LIBRARY
-- Self-contained library with automatic settings persistence
-- Version 2.0

local Library = {}
Library.__index = Library

-- Services
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

-- Configuration
local CONFIG = {
    SaveFileName = "UILibrarySettings.json",
    AnimationSpeed = 0.3,
    NotificationDuration = 3,
    DefaultSize = Vector2.new(550, 400),
}

-- Theme colors
local THEMES = {
    cherry = {
        primary = Color3.fromRGB(255, 85, 127),
        secondary = Color3.fromRGB(180, 60, 90),
        background = Color3.fromRGB(20, 20, 25),
        surface = Color3.fromRGB(30, 30, 35),
        text = Color3.fromRGB(255, 255, 255),
        textDim = Color3.fromRGB(180, 180, 185)
    },
    ocean = {
        primary = Color3.fromRGB(52, 152, 219),
        secondary = Color3.fromRGB(41, 128, 185),
        background = Color3.fromRGB(20, 20, 25),
        surface = Color3.fromRGB(30, 30, 35),
        text = Color3.fromRGB(255, 255, 255),
        textDim = Color3.fromRGB(180, 180, 185)
    },
    grape = {
        primary = Color3.fromRGB(155, 89, 182),
        secondary = Color3.fromRGB(142, 68, 173),
        background = Color3.fromRGB(20, 20, 25),
        surface = Color3.fromRGB(30, 30, 35),
        text = Color3.fromRGB(255, 255, 255),
        textDim = Color3.fromRGB(180, 180, 185)
    },
    lime = {
        primary = Color3.fromRGB(46, 204, 113),
        secondary = Color3.fromRGB(39, 174, 96),
        background = Color3.fromRGB(20, 20, 25),
        surface = Color3.fromRGB(30, 30, 35),
        text = Color3.fromRGB(255, 255, 255),
        textDim = Color3.fromRGB(180, 180, 185)
    }
}

-- Utility functions
local function tween(instance, properties, duration)
    duration = duration or CONFIG.AnimationSpeed
    local tweenInfo = TweenInfo.new(duration, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    TweenService:Create(instance, tweenInfo, properties):Play()
end

local function saveSettings(settings)
    local success, result = pcall(function()
        local json = HttpService:JSONEncode(settings)
        writefile(CONFIG.SaveFileName, json)
    end)
    return success
end

local function loadSettings()
    local success, result = pcall(function()
        if isfile(CONFIG.SaveFileName) then
            local json = readfile(CONFIG.SaveFileName)
            return HttpService:JSONDecode(json)
        end
    end)
    return success and result or {}
end

-- Create UI Library
function Library.new(config)
    local self = setmetatable({}, Library)
    
    config = config or {}
    self.theme = THEMES[config.theme or "cherry"]
    self.rounding = config.rounding ~= false
    self.smoothDragging = config.smoothDragging or false
    self.autoDisableToggles = config.autoDisableToggles ~= false
    
    self.windows = {}
    self.settings = loadSettings()
    self.activeToggles = {}
    
    -- Create ScreenGui
    self.gui = Instance.new("ScreenGui")
    self.gui.Name = "EnhancedUILibrary"
    self.gui.ResetOnSpawn = false
    self.gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    
    if gethui then
        self.gui.Parent = gethui()
    elseif syn and syn.protect_gui then
        syn.protect_gui(self.gui)
        self.gui.Parent = game:GetService("CoreGui")
    else
        self.gui.Parent = game:GetService("CoreGui")
    end
    
    return self
end

-- Notification system
function Library:notify(config)
    local notif = Instance.new("Frame")
    notif.Name = "Notification"
    notif.Size = UDim2.new(0, 300, 0, 80)
    notif.Position = UDim2.new(1, -320, 1, 100)
    notif.BackgroundColor3 = self.theme.surface
    notif.BorderSizePixel = 0
    notif.Parent = self.gui
    
    if self.rounding then
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 8)
        corner.Parent = notif
    end
    
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -20, 0, 25)
    title.Position = UDim2.new(0, 10, 0, 10)
    title.BackgroundTransparency = 1
    title.Text = config.title or "Notification"
    title.TextColor3 = self.theme.text
    title.TextSize = 16
    title.Font = Enum.Font.GothamBold
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.Parent = notif
    
    local message = Instance.new("TextLabel")
    message.Name = "Message"
    message.Size = UDim2.new(1, -20, 0, 35)
    message.Position = UDim2.new(0, 10, 0, 35)
    message.BackgroundTransparency = 1
    message.Text = config.message or ""
    message.TextColor3 = self.theme.textDim
    message.TextSize = 14
    message.Font = Enum.Font.Gotham
    message.TextXAlignment = Enum.TextXAlignment.Left
    message.TextWrapped = true
    message.Parent = notif
    
    tween(notif, {Position = UDim2.new(1, -320, 1, -100)}, 0.5)
    
    task.delay(config.duration or CONFIG.NotificationDuration, function()
        tween(notif, {Position = UDim2.new(1, -320, 1, 100)}, 0.5)
        task.wait(0.5)
        notif:Destroy()
    end)
end

-- Create Window
function Library:newWindow(config)
    local window = {}
    window.menus = {}
    window.settings = {}
    
    local size = config.size or CONFIG.DefaultSize
    if typeof(size) == "UDim2" then
        size = Vector2.new(size.X.Offset, size.Y.Offset)
    end
    
    -- Main window frame
    local frame = Instance.new("Frame")
    frame.Name = "Window"
    frame.Size = UDim2.new(0, size.X, 0, size.Y)
    frame.Position = config.position or UDim2.new(0.5, -size.X/2, 0.5, -size.Y/2)
    frame.BackgroundColor3 = self.theme.background
    frame.BorderSizePixel = 0
    frame.Active = true
    frame.Parent = self.gui
    
    if self.rounding then
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 10)
        corner.Parent = frame
    end
    
    -- Title bar
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 40)
    titleBar.BackgroundColor3 = self.theme.surface
    titleBar.BorderSizePixel = 0
    titleBar.Parent = frame
    
    if self.rounding then
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 10)
        corner.Parent = titleBar
        
        local coverBottom = Instance.new("Frame")
        coverBottom.Size = UDim2.new(1, 0, 0, 10)
        coverBottom.Position = UDim2.new(0, 0, 1, -10)
        coverBottom.BackgroundColor3 = self.theme.surface
        coverBottom.BorderSizePixel = 0
        coverBottom.Parent = titleBar
    end
    
    local titleText = Instance.new("TextLabel")
    titleText.Name = "Title"
    titleText.Size = UDim2.new(1, -100, 1, 0)
    titleText.Position = UDim2.new(0, 15, 0, 0)
    titleText.BackgroundTransparency = 1
    titleText.Text = config.text or "Window"
    titleText.TextColor3 = self.theme.text
    titleText.TextSize = 18
    titleText.Font = Enum.Font.GothamBold
    titleText.TextXAlignment = Enum.TextXAlignment.Left
    titleText.Parent = titleBar
    
    -- Close button
    local closeBtn = Instance.new("TextButton")
    closeBtn.Name = "CloseButton"
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -40, 0.5, -15)
    closeBtn.BackgroundColor3 = self.theme.primary
    closeBtn.Text = "X"
    closeBtn.TextColor3 = self.theme.text
    closeBtn.TextSize = 16
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.BorderSizePixel = 0
    closeBtn.Parent = titleBar
    
    if self.rounding then
        local corner = Instance.new("UICorner")
        corner.CornerRadius = UDim.new(0, 6)
        corner.Parent = closeBtn
    end
    
    closeBtn.MouseButton1Click:Connect(function()
        if self.autoDisableToggles then
            for _, toggle in pairs(self.activeToggles) do
                if toggle.setState then
                    toggle:setState(false)
                end
            end
        end
        saveSettings(window.settings)
        frame:Destroy()
    end)
    
    -- Menu container
    local menuBar = Instance.new("Frame")
    menuBar.Name = "MenuBar"
    menuBar.Size = UDim2.new(1, 0, 0, 35)
    menuBar.Position = UDim2.new(0, 0, 0, 40)
    menuBar.BackgroundColor3 = self.theme.surface
    menuBar.BorderSizePixel = 0
    menuBar.Parent = frame
    
    local menuList = Instance.new("UIListLayout")
    menuList.FillDirection = Enum.FillDirection.Horizontal
    menuList.HorizontalAlignment = Enum.HorizontalAlignment.Left
    menuList.Padding = UDim.new(0, 5)
    menuList.Parent = menuBar
    
    local menuPadding = Instance.new("UIPadding")
    menuPadding.PaddingLeft = UDim.new(0, 10)
    menuPadding.PaddingTop = UDim.new(0, 5)
    menuPadding.Parent = menuBar
    
    -- Content container
    local content = Instance.new("Frame")
    content.Name = "Content"
    content.Size = UDim2.new(1, 0, 1, -75)
    content.Position = UDim2.new(0, 0, 0, 75)
    content.BackgroundTransparency = 1
    content.Parent = frame
    
    -- Dragging functionality
    local dragging, dragInput, dragStart, startPos
    
    local function update(input)
        local delta = input.Position - dragStart
        if self.smoothDragging then
            tween(frame, {Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)}, 0.1)
        else
            frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end
    
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    titleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
    
    -- Add menu function
    function window:addMenu(menuConfig)
        local menu = {}
        menu.sections = {}
        menu.visible = #self.menus == 0
        
        local menuBtn = Instance.new("TextButton")
        menuBtn.Name = menuConfig.text
        menuBtn.Size = UDim2.new(0, 100, 0, 25)
        menuBtn.BackgroundColor3 = menu.visible and self.theme.primary or self.theme.background
        menuBtn.Text = menuConfig.text or "Menu"
        menuBtn.TextColor3 = self.theme.text
        menuBtn.TextSize = 14
        menuBtn.Font = Enum.Font.GothamBold
        menuBtn.BorderSizePixel = 0
        menuBtn.Parent = menuBar
        
        if self.rounding then
            local corner = Instance.new("UICorner")
            corner.CornerRadius = UDim.new(0, 6)
            corner.Parent = menuBtn
        end
        
        local menuContent = Instance.new("ScrollingFrame")
        menuContent.Name = "MenuContent"
        menuContent.Size = UDim2.new(1, -20, 1, -10)
        menuContent.Position = UDim2.new(0, 10, 0, 5)
        menuContent.BackgroundTransparency = 1
        menuContent.BorderSizePixel = 0
        menuContent.ScrollBarThickness = 4
        menuContent.ScrollBarImageColor3 = self.theme.primary
        menuContent.Visible = menu.visible
        menuContent.Parent = content
        
        local leftColumn = Instance.new("Frame")
        leftColumn.Name = "LeftColumn"
        leftColumn.Size = UDim2.new(0.5, -5, 1, 0)
        leftColumn.BackgroundTransparency = 1
        leftColumn.Parent = menuContent
        
        local leftList = Instance.new("UIListLayout")
        leftList.Padding = UDim.new(0, 10)
        leftList.Parent = leftColumn
        
        local rightColumn = Instance.new("Frame")
        rightColumn.Name = "RightColumn"
        rightColumn.Size = UDim2.new(0.5, -5, 1, 0)
        rightColumn.Position = UDim2.new(0.5, 5, 0, 0)
        rightColumn.BackgroundTransparency = 1
        rightColumn.Parent = menuContent
        
        local rightList = Instance.new("UIListLayout")
        rightList.Padding = UDim.new(0, 10)
        rightList.Parent = rightColumn
        
        menuBtn.MouseButton1Click:Connect(function()
            for _, m in pairs(self.menus) do
                m.content.Visible = false
                m.button.BackgroundColor3 = self.theme.background
            end
            menuContent.Visible = true
            menuBtn.BackgroundColor3 = self.theme.primary
        end)
        
        menu.button = menuBtn
        menu.content = menuContent
        menu.leftColumn = leftColumn
        menu.rightColumn = rightColumn
        menu.leftList = leftList
        menu.rightList = rightList
        
        table.insert(self.menus, menu)
        
        function menu:addSection(sectionConfig)
            local section = {}
            section.controls = {}
            
            local side = sectionConfig.side or "auto"
            local parent = leftColumn
            
            if side == "right" then
                parent = rightColumn
            elseif side == "auto" then
                parent = (#leftList:GetChildren() <= #rightList:GetChildren()) and leftColumn or rightColumn
            end
            
            local sectionFrame = Instance.new("Frame")
            sectionFrame.Name = "Section"
            sectionFrame.Size = UDim2.new(1, 0, 0, 40)
            sectionFrame.BackgroundColor3 = self.theme.surface
            sectionFrame.BorderSizePixel = 0
            sectionFrame.Parent = parent
            
            if self.rounding then
                local corner = Instance.new("UICorner")
                corner.CornerRadius = UDim.new(0, 8)
                corner.Parent = sectionFrame
            end
            
            local sectionTitle = Instance.new("TextLabel")
            sectionTitle.Name = "Title"
            sectionTitle.Size = UDim2.new(1, -40, 0, 30)
            sectionTitle.Position = UDim2.new(0, 10, 0, 5)
            sectionTitle.BackgroundTransparency = 1
            sectionTitle.Text = sectionConfig.text or "Section"
            sectionTitle.TextColor3 = self.theme.text
            sectionTitle.TextSize = 14
            sectionTitle.Font = Enum.Font.GothamBold
            sectionTitle.TextXAlignment = Enum.TextXAlignment.Left
            sectionTitle.Parent = sectionFrame
            
            local contentContainer = Instance.new("Frame")
            contentContainer.Name = "Content"
            contentContainer.Size = UDim2.new(1, -20, 1, -40)
            contentContainer.Position = UDim2.new(0, 10, 0, 35)
            contentContainer.BackgroundTransparency = 1
            contentContainer.Parent = sectionFrame
            
            local contentList = Instance.new("UIListLayout")
            contentList.Padding = UDim.new(0, 5)
            contentList.Parent = contentContainer
            
            contentList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
                sectionFrame.Size = UDim2.new(1, 0, 0, contentList.AbsoluteContentSize.Y + 45)
            end)
            
            if sectionConfig.showMinButton ~= false then
                local minBtn = Instance.new("TextButton")
                minBtn.Name = "MinimizeButton"
                minBtn.Size = UDim2.new(0, 20, 0, 20)
                minBtn.Position = UDim2.new(1, -30, 0, 10)
                minBtn.BackgroundTransparency = 1
                minBtn.Text = "-"
                minBtn.TextColor3 = self.theme.textDim
                minBtn.TextSize = 18
                minBtn.Font = Enum.Font.GothamBold
                minBtn.Parent = sectionFrame
                
                minBtn.MouseButton1Click:Connect(function()
                    contentContainer.Visible = not contentContainer.Visible
                    minBtn.Text = contentContainer.Visible and "-" or "+"
                    sectionFrame.Size = contentContainer.Visible and UDim2.new(1, 0, 0, contentList.AbsoluteContentSize.Y + 45) or UDim2.new(1, 0, 0, 40)
                end)
            end
            
            section.frame = sectionFrame
            section.container = contentContainer
            
            function section:addLabel(labelConfig)
                local label = Instance.new("TextLabel")
                label.Name = "Label"
                label.Size = UDim2.new(1, 0, 0, 20)
                label.BackgroundTransparency = 1
                label.Text = labelConfig.text or "Label"
                label.TextColor3 = self.theme.textDim
                label.TextSize = 13
                label.Font = Enum.Font.Gotham
                label.TextXAlignment = Enum.TextXAlignment.Left
                label.Parent = contentContainer
                
                local obj = {}
                function obj:setText(text)
                    label.Text = text
                end
                
                return obj
            end
            
            function section:addToggle(toggleConfig)
                local toggle = {}
                local settingKey = toggleConfig.text .. "_toggle"
                local state = window.settings[settingKey] or toggleConfig.state or false
                
                local toggleFrame = Instance.new("Frame")
                toggleFrame.Name = "Toggle"
                toggleFrame.Size = UDim2.new(1, 0, 0, 30)
                toggleFrame.BackgroundTransparency = 1
                toggleFrame.Parent = contentContainer
                
                local toggleLabel = Instance.new("TextLabel")
                toggleLabel.Size = UDim2.new(1, -40, 1, 0)
                toggleLabel.BackgroundTransparency = 1
                toggleLabel.Text = toggleConfig.text or "Toggle"
                toggleLabel.TextColor3 = self.theme.text
                toggleLabel.TextSize = 13
                toggleLabel.Font = Enum.Font.Gotham
                toggleLabel.TextXAlignment = Enum.TextXAlignment.Left
                toggleLabel.Parent = toggleFrame
                
                local toggleBtn = Instance.new("TextButton")
                toggleBtn.Name = "Button"
                toggleBtn.Size = UDim2.new(0, 35, 0, 18)
                toggleBtn.Position = UDim2.new(1, -35, 0.5, -9)
                toggleBtn.BackgroundColor3 = state and self.theme.primary or self.theme.background
                toggleBtn.Text = ""
                toggleBtn.BorderSizePixel = 0
                toggleBtn.Parent = toggleFrame
                
                if self.rounding then
                    local corner = Instance.new("UICorner")
                    corner.CornerRadius = UDim.new(1, 0)
                    corner.Parent = toggleBtn
                end
                
                local indicator = Instance.new("Frame")
                indicator.Name = "Indicator"
                indicator.Size = UDim2.new(0, 14, 0, 14)
                indicator.Position = state and UDim2.new(1, -16, 0.5, -7) or UDim2.new(0, 2, 0.5, -7)
                indicator.BackgroundColor3 = self.theme.text
                indicator.BorderSizePixel = 0
                indicator.Parent = toggleBtn
                
                if self.rounding then
                    local corner = Instance.new("UICorner")
                    corner.CornerRadius = UDim.new(1, 0)
                    corner.Parent = indicator
                end
                
                toggle.state = state
                toggle.callbacks = {}
                
                function toggle:setState(newState, silent)
                    self.state = newState
                    tween(toggleBtn, {BackgroundColor3 = newState and self.theme.primary or self.theme.background})
                    tween(indicator, {Position = newState and UDim2.new(1, -16, 0.5, -7) or UDim2.new(0, 2, 0.5, -7)})
                    window.settings[settingKey] = newState
                    if not silent then
                        for _, callback in pairs(self.callbacks) do
                            task.spawn(callback, newState)
                        end
                    end
                end
                
                function toggle:bindToEvent(event, callback)
                    if event == "onToggle" then
                        table.insert(self.callbacks, callback)
                    end
                    return self
                end
                
                function toggle:setTooltip(text)
                    -- Tooltip implementation would go here
                    return self
                end
                
                toggleBtn.MouseButton1Click:Connect(function()
                    toggle:setState(not toggle.state)
                end)
                
                if state then
                    toggle:setState(true, true)
                end
                
                table.insert(self.activeToggles, toggle)
                return toggle
            end
            
            function section:addButton(buttonConfig, callback)
                local button = {}
                
                local style = buttonConfig.style or "small"
                local height = style == "large" and 35 or 28
                
                local buttonFrame = Instance.new("TextButton")
                buttonFrame.Name = "Button"
                buttonFrame.Size = UDim2.new(1, 0, 0, height)
                buttonFrame.BackgroundColor3 = self.theme.primary
                buttonFrame.Text = buttonConfig.text or "Button"
                buttonFrame.TextColor3 = self.theme.text
                buttonFrame.TextSize = style == "large" and 14 or 13
                buttonFrame.Font = Enum.Font.GothamBold
                buttonFrame.BorderSizePixel = 0
                buttonFrame.Parent = contentContainer
                
                if self.rounding then
                    local corner = Instance.new("UICorner")
                    corner.CornerRadius = UDim.new(0, 6)
                    corner.Parent = buttonFrame
                end
                
                button.callbacks = {}
                if callback then
                    table.insert(button.callbacks, callback)
                end
                
                function button:bindToEvent(event, cb)
                    if event == "onClick" then
                        table.insert(self.callbacks, cb)
                    end
                    return self
                end
                
                function button:setTooltip(text)
                    return self
                end
                
                buttonFrame.MouseButton1Click:Connect(function()
                    tween(buttonFrame, {BackgroundColor3 = self.theme.secondary}, 0.1)
                    task.wait(0.1)
                    tween(buttonFrame, {BackgroundColor3 = self.theme.primary}, 0.1)
                    for _, cb in pairs(button.callbacks) do
                        task.spawn(cb)
                    end
                end)
                
                return button
            end
            
            function section:addSlider(sliderConfig, callback)
                local slider = {}
                local settingKey = sliderConfig.text .. "_slider"
                local value = window.settings[settingKey] or sliderConfig.val or sliderConfig.min
                
                local sliderFrame = Instance.new("Frame")
                sliderFrame.Name = "Slider"
                sliderFrame.Size = UDim2.new(1, 0, 0, 45)
                sliderFrame.BackgroundTransparency = 1
                sliderFrame.Parent = contentContainer
                
                local sliderLabel = Instance.new("TextLabel")
                sliderLabel.Size = UDim2.new(0.7, 0, 0, 20)
                sliderLabel.BackgroundTransparency = 1
                sliderLabel.Text = sliderConfig.text or "Slider"
                sliderLabel.TextColor3 = self.theme.text
                sliderLabel.TextSize = 13
                sliderLabel.Font = Enum.Font.Gotham
                sliderLabel.TextXAlignment = Enum.TextXAlignment.Left
                sliderLabel.Parent = sliderFrame
                
                local valueLabel = Instance.new("TextLabel")
                valueLabel.Size = UDim2.new(0.3, 0, 0, 20)
                valueLabel.Position = UDim2.new(0.7, 0, 0, 0)
                valueLabel.BackgroundTransparency = 1
                valueLabel.Text = tostring(value)
                valueLabel.TextColor3 = self.theme.primary
                valueLabel.TextSize = 13
                valueLabel.Font = Enum.Font.GothamBold
                valueLabel.TextXAlignment = Enum.TextXAlignment.Right
                valueLabel.Parent = sliderFrame
                
                local sliderBg = Instance.new("Frame")
                sliderBg.Name = "Background"
                sliderBg.Size = UDim2.new(1, 0, 0, 6)
                sliderBg.Position = UDim2.new(0, 0, 0, 30)
                sliderBg.BackgroundColor3 = self.theme.background
                sliderBg.BorderSizePixel = 0
                sliderBg.Parent = sliderFrame
                
                if self.rounding then
                    local corner = Instance.new("UICorner")
                    corner.CornerRadius = UDim.new(1, 0)
                    corner.Parent = sliderBg
                end
                
                local sliderFill = Instance.new("Frame")
                sliderFill.Name = "Fill"
                sliderFill.Size = UDim2.new((value - sliderConfig.min) / (sliderConfig.max - sliderConfig.min), 0, 1, 0)
                sliderFill.BackgroundColor3 = self.theme.primary
                sliderFill.BorderSizePixel = 0
                sliderFill.Parent = sliderBg
                
                if self.rounding then
                    local corner = Instance.new("UICorner")
                    corner.CornerRadius = UDim.new(1, 0)
                    corner.Parent = sliderFill
                end
                
                slider.value = value
                slider.callbacks = {}
                if callback then
                    table.insert(slider.callbacks, callback)
                end
                
                function slider:setValue(newValue)
                    newValue = math.clamp(newValue, sliderConfig.min, sliderConfig.max)
                    if sliderConfig.step then
                        newValue = math.floor(newValue / sliderConfig.step + 0.5) * sliderConfig.step
                    end
                    self.value = newValue
                    valueLabel.Text = tostring(newValue)
                    tween(sliderFill, {Size = UDim2.new((newValue - sliderConfig.min) / (sliderConfig.max - sliderConfig.min), 0, 1, 0)}, 0.1)
                    window.settings[settingKey] = newValue
                    for _, cb in pairs(self.callbacks) do
                        task.spawn(cb, newValue)
                    end
                end
                
                function slider:setTooltip(text)
                    return self
                end
                
                local dragging = false
                
                sliderBg.InputBegan:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        dragging = true
                        local function update()
                            local mousePos = UserInputService:GetMouseLocation().X
                            local sliderPos = sliderBg.AbsolutePosition.X
                            local sliderSize = sliderBg.AbsoluteSize.X
                            local percent = math.clamp((mousePos - sliderPos) / sliderSize, 0, 1)
                            local newValue = sliderConfig.min + (sliderConfig.max - sliderConfig.min) * percent
                            slider:setValue(newValue)
                        end
                        update()
                        local connection
                        connection = RunService.RenderStepped:Connect(function()
                            if dragging then
                                update()
                            else
                                connection:Disconnect()
                            end
                        end)
                    end
                end)
                
                UserInputService.InputEnded:Connect(function(input)
                    if input.UserInputType == Enum.UserInputType.MouseButton1 then
                        dragging = false
                    end
                end)
                
                if window.settings[settingKey] then
                    slider:setValue(window.settings[settingKey])
                end
                
                return slider
            end
            
            function section:addColorPicker(colorConfig, callback)
                local colorPicker = {}
                local settingKey = colorConfig.text .. "_color"
                local color = window.settings[settingKey] or colorConfig.color or Color3.fromRGB(255, 0, 0)
                
                local pickerFrame = Instance.new("Frame")
                pickerFrame.Name = "ColorPicker"
                pickerFrame.Size = UDim2.new(1, 0, 0, 30)
                pickerFrame.BackgroundTransparency = 1
                pickerFrame.Parent = contentContainer
                
                local pickerLabel = Instance.new("TextLabel")
                pickerLabel.Size = UDim2.new(1, -40, 1, 0)
                pickerLabel.BackgroundTransparency = 1
                pickerLabel.Text = colorConfig.text or "Color"
                pickerLabel.TextColor3 = self.theme.text
                pickerLabel.TextSize = 13
                pickerLabel.Font = Enum.Font.Gotham
                pickerLabel.TextXAlignment = Enum.TextXAlignment.Left
                pickerLabel.Parent = pickerFrame
                
                local colorDisplay = Instance.new("TextButton")
                colorDisplay.Size = UDim2.new(0, 30, 0, 20)
                colorDisplay.Position = UDim2.new(1, -35, 0.5, -10)
                colorDisplay.BackgroundColor3 = color
                colorDisplay.Text = ""
                colorDisplay.BorderSizePixel = 0
                colorDisplay.Parent = pickerFrame
                
                if self.rounding then
                    local corner = Instance.new("UICorner")
                    corner.CornerRadius = UDim.new(0, 4)
                    corner.Parent = colorDisplay
                end
                
                colorPicker.callbacks = {}
                if callback then
                    table.insert(colorPicker.callbacks, callback)
                end
                
                function colorPicker:setColor(newColor)
                    color = newColor
                    colorDisplay.BackgroundColor3 = newColor
                    window.settings[settingKey] = {newColor.R, newColor.G, newColor.B}
                    for _, cb in pairs(self.callbacks) do
                        task.spawn(cb, newColor)
                    end
                end
                
                colorDisplay.MouseButton1Click:Connect(function()
                    -- Simple color picker - cycles through preset colors
                    local colors = {
                        Color3.fromRGB(255, 0, 0),
                        Color3.fromRGB(255, 127, 0),
                        Color3.fromRGB(255, 255, 0),
                        Color3.fromRGB(0, 255, 0),
                        Color3.fromRGB(0, 127, 255),
                        Color3.fromRGB(0, 0, 255),
                        Color3.fromRGB(127, 0, 255),
                        Color3.fromRGB(255, 0, 255)
                    }
                    local currentIndex = 1
                    for i, c in ipairs(colors) do
                        if math.abs(c.R - color.R) < 0.1 and math.abs(c.G - color.G) < 0.1 and math.abs(c.B - color.B) < 0.1 then
                            currentIndex = i
                            break
                        end
                    end
                    local nextIndex = (currentIndex % #colors) + 1
                    colorPicker:setColor(colors[nextIndex])
                end)
                
                if window.settings[settingKey] then
                    local saved = window.settings[settingKey]
                    colorPicker:setColor(Color3.new(saved[1], saved[2], saved[3]))
                end
                
                return colorPicker
            end
            
            function section:addTextbox(textboxConfig)
                local textbox = {}
                local settingKey = textboxConfig.text .. "_textbox"
                
                local textboxFrame = Instance.new("Frame")
                textboxFrame.Name = "Textbox"
                textboxFrame.Size = UDim2.new(1, 0, 0, 50)
                textboxFrame.BackgroundTransparency = 1
                textboxFrame.Parent = contentContainer
                
                local textboxLabel = Instance.new("TextLabel")
                textboxLabel.Size = UDim2.new(1, 0, 0, 20)
                textboxLabel.BackgroundTransparency = 1
                textboxLabel.Text = textboxConfig.text or "Textbox"
                textboxLabel.TextColor3 = self.theme.text
                textboxLabel.TextSize = 13
                textboxLabel.Font = Enum.Font.Gotham
                textboxLabel.TextXAlignment = Enum.TextXAlignment.Left
                textboxLabel.Parent = textboxFrame
                
                local input = Instance.new("TextBox")
                input.Size = UDim2.new(1, 0, 0, 25)
                input.Position = UDim2.new(0, 0, 0, 25)
                input.BackgroundColor3 = self.theme.background
                input.Text = window.settings[settingKey] or ""
                input.PlaceholderText = "Enter text..."
                input.TextColor3 = self.theme.text
                input.PlaceholderColor3 = self.theme.textDim
                input.TextSize = 13
                input.Font = Enum.Font.Gotham
                input.BorderSizePixel = 0
                input.Parent = textboxFrame
                
                if self.rounding then
                    local corner = Instance.new("UICorner")
                    corner.CornerRadius = UDim.new(0, 4)
                    corner.Parent = input
                end
                
                textbox.callbacks = {}
                
                function textbox:bindToEvent(event, callback)
                    if event == "onFocusLost" then
                        table.insert(self.callbacks, callback)
                    end
                    return self
                end
                
                input.FocusLost:Connect(function()
                    window.settings[settingKey] = input.Text
                    for _, cb in pairs(textbox.callbacks) do
                        task.spawn(cb, input.Text)
                    end
                end)
                
                return textbox
            end
            
            function section:addHotkey(hotkeyConfig)
                local hotkey = {}
                local currentKey = nil
                local linkedControl = nil
                
                local hotkeyFrame = Instance.new("Frame")
                hotkeyFrame.Name = "Hotkey"
                hotkeyFrame.Size = UDim2.new(1, 0, 0, 30)
                hotkeyFrame.BackgroundTransparency = 1
                hotkeyFrame.Parent = contentContainer
                
                local hotkeyLabel = Instance.new("TextLabel")
                hotkeyLabel.Size = UDim2.new(1, -60, 1, 0)
                hotkeyLabel.BackgroundTransparency = 1
                hotkeyLabel.Text = hotkeyConfig.text or "Hotkey"
                hotkeyLabel.TextColor3 = self.theme.text
                hotkeyLabel.TextSize = 13
                hotkeyLabel.Font = Enum.Font.Gotham
                hotkeyLabel.TextXAlignment = Enum.TextXAlignment.Left
                hotkeyLabel.Parent = hotkeyFrame
                
                local hotkeyDisplay = Instance.new("TextLabel")
                hotkeyDisplay.Size = UDim2.new(0, 50, 0, 20)
                hotkeyDisplay.Position = UDim2.new(1, -55, 0.5, -10)
                hotkeyDisplay.BackgroundColor3 = self.theme.background
                hotkeyDisplay.Text = "..."
                hotkeyDisplay.TextColor3 = self.theme.textDim
                hotkeyDisplay.TextSize = 12
                hotkeyDisplay.Font = Enum.Font.Gotham
                hotkeyDisplay.BorderSizePixel = 0
                hotkeyDisplay.Parent = hotkeyFrame
                
                if self.rounding then
                    local corner = Instance.new("UICorner")
                    corner.CornerRadius = UDim.new(0, 4)
                    corner.Parent = hotkeyDisplay
                end
                
                function hotkey:setHotkey(keyCode)
                    currentKey = keyCode
                    hotkeyDisplay.Text = keyCode.Name
                end
                
                function hotkey:linkToControl(control)
                    linkedControl = control
                end
                
                function hotkey:setTooltip(text)
                    return self
                end
                
                UserInputService.InputBegan:Connect(function(input, gameProcessed)
                    if gameProcessed or not currentKey or not linkedControl then return end
                    
                    if input.KeyCode == currentKey then
                        if linkedControl.setState then
                            linkedControl:setState(not linkedControl.state)
                        end
                    end
                end)
                
                return hotkey
            end
            
            table.insert(self.sections, section)
            return section
        end
        
        return menu
    end
    
    table.insert(self.windows, window)
    return window
end

return Library
